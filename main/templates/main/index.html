{% load static %}
<!DOCTYPE html>
<html lang="gu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SlimaX Powder - рк╡ркЬрки ркШркЯрк╛ркбрлЛ рк╕рк░рк│ рк░рлАркдрлЗ!</title>
  <link rel="stylesheet" href="{% static 'main/style.css' %}">
</head>
<body>

  <!-- Header -->
  <header class="header">
    <h1>ркЕрк╣рлЗрк╡рк╛рк▓: ркЕркоркжрк╛рк╡рк╛ркж ркирк╛ рк╡рк┐ркорк▓ркЬрлА ркП рклркХрлНркд 2 ркорк╣рк┐ркирк╛ркорк╛ркВ 20 ркХрк┐.ркЧрлНрк░рк╛. рк╡ркЬрки ркШркЯрк╛ркбрлНркпрлБркВ!</h1>
    <p>ркХрлЛркИ ркорлБрк╢рлНркХрлЗрк▓рлА рк╡ркЧрк░ ркЕркирлЗ ркбрк╛ркпркЯрк┐ркВркЧ ркХрк░рлНркпрк╛ рк╡рк┐ркирк╛ ркЕркжрлНркнрлБркд рккрк░рк┐ркгрк╛рко!</p>
  </header>

  <!-- Story Section -->
  <section class="story">
    <img src="https://via.placeholder.com/400x250?text=Before+After" alt="Before After">
    <p><strong>рк╣рлЗрк▓рлЛ ркорк┐ркдрлНрк░рлЛ!</strong> рк╣рлБркВ рк╡рк┐ркорк▓ ркЫрлБркВ, ркорк╛рк░рлА ркЙркВркорк░ 48 рк╡рк░рлНрк╖ ркЫрлЗ. ркорк╛рк░рлА ркмрк┐ркЭрлА рк▓рк╛ркИрклрк╕рлНркЯрк╛ркИрк▓ркирлЗ ркХрк╛рк░ркгрлЗ ркорк╛рк░рлБркВ рк╡ркЬрки 90 ркХрк┐рк▓рлЛ ркеркИ ркЧркпрлБркВ рк╣ркдрлБркВ. рккркЫрлА ркорлЗркВ <strong>SlimaX Powder</strong> ркирлЛ ркЙрккркпрлЛркЧ рк╢рк░рлВ ркХрк░рлНркпрлЛ ркЕркирлЗ рклркХрлНркд 2 ркорк╣рк┐ркирк╛ркорк╛ркВ 20 ркХрк┐рк▓рлЛ ркУркЫрлБркВ ркХрк░рлНркпрлБркВ!</p>
  </section>

  <!-- Product Section -->
  <section class="product-section">
    <img src="https://via.placeholder.com/400x250?text=SlimaX+Powder" alt="SlimaX Powder">
    <p><strong>SlimaX Powder</strong> ркПркХ 100% рк╣рк░рлНркмрк▓ рк╕рккрлНрк▓рк┐ркорлЗркирлНркЯ ркЫрлЗ ркЬрлЗ рк╢рк░рлАрк░ркорк╛ркВркерлА ркЪрк░ркмрлА ркУркЫрлА ркХрк░рлЗ ркЫрлЗ, ркорлЗркЯрк╛ркмрлЛрк▓рк┐ркЭрко рк╡ркзрк╛рк░рлЗ ркЫрлЗ ркЕркирлЗ ркПркирк░рлНркЬрлА ркЖрккрлЗ ркЫрлЗ.</p>
    <ul>
      <li>тЬЕ 100% ркирлЗркЪрк░рк▓ ркЕркирлЗ рк╕рлЗркл</li>
      <li>тЬЕ ркбрк╛ркпркЯрк┐ркВркЧ ркХрлЗ ркПркХрлНрк╕рк░рк╕рк╛ркИркЭ рк╡рк┐ркирк╛ рк╡ркЬрки ркШркЯрк╛ркбрлЛ</li>
      <li>тЬЕ 15 ркжрк┐рк╡рк╕ркорк╛ркВ рккрк░рк┐ркгрк╛рко ркжрлЗркЦрк╛рк╢рлЗ</li>
    </ul>
  </section>

  <!-- Form Box Section -->
  <section class="form-box">
    <h2>ркЖркЬркирлА ркУрклрк░ ркорлЗрк│рк╡рк╡рк╛ ркорк╛ркЯрлЗ, ркирлАркЪрлЗ ркЖрккрлЗрк▓ рклрлЛрк░рлНрко ркнрк░рлЛ ркЕркирлЗ рк╣ркоркгрк╛ркВ ркЬ ркУрк░рлНркбрк░ ркХрк░рлЛ</h2>
    <div class="price-box">
      <p class="old-price">Old Price - тВ╣2998</p>
      <p class="new-price">New Price - тВ╣1499</p>
    </div>
    
    <!-- Display messages -->
    {% if messages %}
      <div style="margin: 10px 0; padding: 10px; background: #f9e791; border-radius: 5px; color: #000;">
        {% for message in messages %}
          <p style="margin: 0;">{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}
    
    <form id="orderForm" method="POST" action="{% url 'index' %}">
      {% csrf_token %}
      <input type="text" id="name" name="name" placeholder="ркирк╛рко" required>
      <div style="position: relative;">
        <input type="tel" id="mobile" name="mobile" placeholder="ркорлЛркмрк╛ркЗрк▓ ркиркВркмрк░" required>
        <div id="mobileError" style="display: none; color: #ff5252; font-size: 14px; margin-top: 5px; padding: 5px; background: #ffe0e0; border-radius: 3px;"></div>
      </div>
      <textarea id="address" name="address" placeholder="рк╕рк░ркирк╛ркорлБркВ" required></textarea>
      <input type="text" id="pincode" name="pincode" placeholder="рккрк┐ркиркХрлЛркб" required>
      <button type="submit">PLACE ORDER</button>
    </form>
    <img src="https://via.placeholder.com/250x150?text=SlimaX+Powder" alt="SlimaX Product" class="form-product">
  </section>

  <!-- WhatsApp Box -->
  <div id="whatsappBox" class="whatsapp-box">
    <div class="chat-header">
      <h4>SlimaX Support</h4>
      <span id="closeChat">тЬЦ</span>
    </div>
    <div class="chat-body">
      <p>ЁЯСЛ ркиркорк╕рлНркдрлЗ! рк╢рлБркВ ркдркорлЗ SlimaX Powder рк╡рк┐рк╢рлЗ ркорк╛рк╣рк┐ркдрлА ркИркЪрлНркЫрлЛ ркЫрлЛ?</p>
      <a href="https://wa.me/919714138494?text=рк╣рлЗрк▓рлЛ!%20ркоркирлЗ%20SlimaX%20Powder%20ркирлЛ%20ркУрк░рлНркбрк░%20ркХрк░рк╡рлЛ%20ркЫрлЗ." target="_blank" class="chat-btn">рк╣рк╛, WhatsApp ркЦрлЛрк▓рлЛ</a>
    </div>
  </div>

  <!-- Fixed Order Now Button -->
  <button id="orderNow" class="fixed-order">ORDER NOW</button>

  <!-- Footer -->
  <footer class="footer">
    <p>┬й 2025 SlimaX Powder | ркмркзрк╛ рк╣ркХрлНркХрлЛ рк╕рлБрк░ркХрлНрк╖рк┐ркд</p>
  </footer>

  <!-- JavaScript -->
  <script>
    const orderBtn = document.getElementById('orderNow');
    const whatsappBox = document.getElementById('whatsappBox');
    const closeChat = document.getElementById('closeChat');
    const form = document.getElementById('orderForm');
    const mobileInput = document.getElementById('mobile');
    const mobileError = document.getElementById('mobileError');
    let mobileCheckTimeout;

    const thankYouUrl = "{% url 'thank_you' %}";
    const checkMobileUrl = "{% url 'check_mobile' %}";

    // Show WhatsApp box when clicking ORDER NOW button
    orderBtn.addEventListener('click', () => {
      whatsappBox.style.display = 'block';
    });

    closeChat.addEventListener('click', () => {
      whatsappBox.style.display = 'none';
    });

    // Real-time mobile number validation
    mobileInput.addEventListener('input', function() {
      const mobile = this.value.trim();
      
      // Clear previous timeout
      clearTimeout(mobileCheckTimeout);
      
      // Hide error message
      mobileError.style.display = 'none';
      mobileInput.style.borderColor = '';
      
      // Only check if mobile number has at least 10 digits
      if (mobile.length >= 10) {
        // Debounce: wait 500ms after user stops typing
        mobileCheckTimeout = setTimeout(() => {
          fetch(`${checkMobileUrl}?mobile=${encodeURIComponent(mobile)}`)
            .then(response => response.json())
            .then(data => {
              if (data.exists) {
                mobileError.textContent = data.message;
                mobileError.style.display = 'block';
                mobileInput.style.borderColor = '#ff5252';
              } else {
                mobileError.style.display = 'none';
                mobileInput.style.borderColor = '#4caf50';
              }
            })
            .catch(error => {
              console.error('Error checking mobile:', error);
            });
        }, 500);
      }
    });

    // Handle form submission - open WhatsApp first, then save to database
    form.addEventListener('submit', function (e) {
      e.preventDefault(); // Prevent default form submission
      
      const name = document.getElementById('name').value;
      const mobile = document.getElementById('mobile').value.trim();
      const address = document.getElementById('address').value;
      const pincode = document.getElementById('pincode').value;

      // Validate form data
      if (!name || !mobile || !address || !pincode) {
        alert('ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркмркзрлА ркорк╛рк╣рк┐ркдрлА ркнрк░рлЛ!');
        return false;
      }

      // Check if mobile number is already registered before submitting
      if (mobileError.style.display === 'block') {
        alert('ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркорк╛ркирлНркп ркорлЛркмрк╛ркЗрк▓ ркиркВркмрк░ ркжрк╛ркЦрк▓ ркХрк░рлЛ!');
        mobileInput.focus();
        return false;
      }

      

      // Prepare form data for submission
      const formData = new FormData(form);
      
      // Submit form data to Django via fetch to save order
      fetch("{% url 'index' %}", {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          return response.json();
        } else {
          // If not JSON, assume success and redirect
          return { success: true };
        }
      })
      .then(data => {
        if (data.success) {          
          // Redirect to thank you page after successful save
          window.location.href = thankYouUrl;
        } else {
          // Show error message
          if (data.error) {
            alert(data.error);
            // If it's a mobile number error, highlight the field
            if (data.error.includes('ркорлЛркмрк╛ркЗрк▓ ркиркВркмрк░')) {
              mobileError.textContent = data.error;
              mobileError.style.display = 'block';
              mobileInput.style.borderColor = '#ff5252';
              mobileInput.focus();
            }
          } else {
            alert('ркХрлЛркИ ркнрлВрк▓ ркЖрк╡рлА. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рклрк░рлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ.');
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
        // On error, still try to redirect (order might have been saved)
        alert('ркУрк░рлНркбрк░ рккрлНрк░ркХрлНрк░рк┐ркпрк╛ ркЪрк╛рк▓рлБ ркЫрлЗ...');
        setTimeout(() => {
          window.location.href = thankYouUrl;
        }, 1000);
      });
    });
  </script>

</body>
</html>
